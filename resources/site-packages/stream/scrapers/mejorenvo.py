from stream import plugin
from stream.scrapers import scraper
from stream.ga import tracked
from stream.caching import cached_route
from stream.utils import ensure_fanart
from stream.library import library_context

BASE_URL = "http://www.mejorenvo.com/descargar-peliculas.html"
HEADERS = {
    "Referer": BASE_URL,
}

@scraper("Mejor en VO")
@plugin.route("/mejorenvo")
def mejorenvo_index():
    print "mejor en VO!"
    plugin.set_content("movies")

    from bs4 import BeautifulSoup
    from stream.utils import url_get
    from stream import tmdb
    import re

    def filter_Desgargar(el):
        return el.has_attr('href') and '-pelicula-' in el['href'] and not 'comentarios' in el['href']

    for url in ["http://www.mejorenvo.com/descargar-peliculas.html","http://www.mejorenvo.com/peliculas-p2.html"]:
        html_data = url_get( url, headers=HEADERS)
        soup = BeautifulSoup(html_data, "html5lib")
        nodes = soup.findAll(filter_Desgargar)
        for node in nodes:
            id = re.search(r'pelicula-(\d+).html', node['href']).group(1)
            torrent_url = 'http://www.mejorenvo.com/descargar.php?t=peliculas&id=' + id + '&torrent=1'

            title_year = node.get_text()
            title = node.stripped_strings.next()
            info = tmdb.search( title )

            info = info['results'][0]
            print title
            print info
            item = tmdb.get_list_item(info)
            item['label'] = '%s (%f)' % (info['title'], info['vote_average'])
            item['path'] = plugin.url_for("play", uri=torrent_url)
            item['is_playable']=True

            yield item